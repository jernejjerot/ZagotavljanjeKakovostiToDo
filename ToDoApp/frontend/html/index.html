<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>To-Do App</title>
        <link rel="stylesheet" href="css/styles.css">
    </head>
    <body>
        <div class="container">
            <h1>To-Do List</h1>

            <div class="navigation">
                <a href="register.html">Register</a>
                <a href="editUser.html">Edit Account</a>
            </div>
            <!-- Login Form -->
            <div class="login-container" style="position: absolute; top: 20px; right: 20px;">
                <input type="text" id="username" placeholder="Enter email">
                <input type="password" id="password" placeholder="Enter password">
                <button id="loginBtn">Login</button>
            </div>
            <div class="logout-container" style="position: absolute; top: 60px; right: 20px;">
                <button id="logoutBtn">Logout</button>
            </div>
            <!-- Task Input Form -->
            <div class="input-container">
                <input type="text" id="newTask" placeholder="Enter new task...">
                <input type="text" id="taskDescription" placeholder="Enter task description...">
                <select id="responsibilitySelect">
                    <option value="1">School</option>
                    <option value="2">Work</option>
                    <option value="3">Home</option>
                </select>
                <input type="date" id="dueDate" placeholder="Select due date">
                <button id="addTaskBtn">Add Task</button>
            </div>
            <ul id="taskList"></ul>

            <!-- dodaj userja forma -->
            <div id="adminContainer" style="display: none;">
                <h3>Create New User</h3>
                <input type="text" id="newUserName" placeholder="First Name">
                <input type="text" id="newUserSurname" placeholder="Last Name">
                <input type="email" id="newUserEmail" placeholder="Email">
                <input type="password" id="newUserPassword" placeholder="Password">
                <select id="newUserAdmin">
                    <option value="false">Regular User</option>
                    <option value="true">Admin</option>
                </select>
                <button id="createUserBtn">Create User</button>
            </div>
        </div>

        <!-- Axios CDN -->
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

        <script>
            let loggedInUserId = null;
            let taskBeingEdited = null;
        
            document.addEventListener('DOMContentLoaded', () => {
                // Check if user is logged in
                const storedUserId = localStorage.getItem('loggedInUserId');
                if (storedUserId) {
                    loggedInUserId = storedUserId; // Set the global loggedInUserId
                    document.querySelector('.login-container').innerHTML = `Logged in as User ID: ${storedUserId}`;
                }
        
                // Attach event listeners
                const loginBtn = document.getElementById('loginBtn');
                const addTaskBtn = document.getElementById('addTaskBtn');
                const logoutBtn = document.getElementById('logoutBtn');
        
                if (loginBtn) loginBtn.addEventListener('click', loginUser);
                if (addTaskBtn) addTaskBtn.addEventListener('click', addOrUpdateTask);
                if (logoutBtn) logoutBtn.addEventListener('click', logoutUser);
        
                // Fetch tasks for the logged-in user
                fetchTasks();
            });
        
            // Login function
            function loginUser() {
                const email = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                axios.post('/users/login', { email, password })
                    .then(response => {
                        localStorage.setItem('loggedInUserId', response.data.userId);
                        loggedInUserId = response.data.userId;

                        // Check admin status
                        if (response.data.isAdmin) {
                            document.getElementById('adminContainer').style.display = 'block'; // Show admin features
                        }
                        alert('Login successful');
                    })
                    .catch(error => {
                        console.error('Error logging in:', error);
                        alert('Login failed');
                    });
            }
        
            // Logout function
            function logoutUser() {
                localStorage.removeItem('loggedInUserId'); // Clear the stored user ID
                loggedInUserId = null; // Clear the global variable
                alert('Logged out successfully.');
                window.location.href = 'index.html'; // Redirect to login page
            }
        
            // Fetch tasks
            function fetchTasks() {
                if (!loggedInUserId) {
                    alert('Please log in to view tasks.');
                    return;
                }
        
                axios.get('/tasks', { headers: { 'user-id': loggedInUserId } })
                    .then(response => {
                        const taskList = document.getElementById('taskList');
                        taskList.innerHTML = ''; // Clear existing tasks
        
                        response.data.forEach(task => {
                            const li = document.createElement('li');
                            const formattedDate = new Date(task.dueDate).toLocaleDateString();
        
                            // Add task details
                            li.textContent = `${task.taskName}: ${task.description} (Due: ${formattedDate})`;
        
                            // Add Edit and Delete buttons
                            createTaskElements(li, task);
        
                            taskList.appendChild(li);
                        });
                    })
                    .catch(error => console.error('Error fetching tasks:', error));
            }
        
            // Add or update task
            function addOrUpdateTask() {
                const taskName = document.getElementById('newTask').value.trim();
                const taskDescription = document.getElementById('taskDescription').value.trim();
                const responsibilityId = document.getElementById('responsibilitySelect').value;
                const dueDate = document.getElementById('dueDate').value;
        
                if (!taskName || !taskDescription || !dueDate || !loggedInUserId) {
                    alert('Please fill in all fields and log in.');
                    return;
                }
        
                const taskData = {
                    taskName: taskName,
                    description: taskDescription,
                    responsibility: { id: responsibilityId },
                    dueDate: dueDate,
                    isCompleted: false,
                };
        
                axios.post('/tasks', taskData, { headers: { 'user-id': loggedInUserId } })
                    .then(() => {
                        console.log('Task created successfully');
                        fetchTasks(); // Refresh tasks
                        clearTaskForm();
                    })
                    .catch((error) => {
                        console.error('Error creating task:', error.response?.data || error.message);
                        alert('Error creating task');
                    });
            }
        
            // Helper to create buttons for task actions (edit and delete)
            function createTaskElements(li, task) {
                // Edit button
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => {
                    editTask(task);
                });
                li.appendChild(editBtn);
        
                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => {
                    axios.delete(`/tasks/${task.id}`, { headers: { 'user-id': loggedInUserId } })
                        .then(() => fetchTasks())
                        .catch(error => console.error('Error deleting task:', error));
                });
                li.appendChild(deleteBtn);
            }
        
            // Edit task function: Populate the form with the task details
            function editTask(task) {
                document.getElementById('newTask').value = task.taskName;
                document.getElementById('taskDescription').value = task.description;
                document.getElementById('responsibilitySelect').value = task.responsibility.id;
                document.getElementById('dueDate').value = new Date(task.dueDate).toISOString().substring(0, 10);
        
                taskBeingEdited = task; // Set the task being edited
            }
        
            // Clear the form after adding or updating a task
            function clearTaskForm() {
                document.getElementById('newTask').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('dueDate').value = '';
                taskBeingEdited = null;
            }

            </script>
            <script>
                function createNewUser() {
                    const newUserName = document.getElementById('newUserName').value.trim();
                    const newUserSurname = document.getElementById('newUserSurname').value.trim();
                    const newUserEmail = document.getElementById('newUserEmail').value.trim();
                    const newUserPassword = document.getElementById('newUserPassword').value.trim();
                    const newUserAdmin = document.getElementById('newUserAdmin').value === 'true';
            
                    if (!newUserName || !newUserSurname || !newUserEmail || !newUserPassword) {
                        alert('Please fill in all fields.');
                        return;
                    }
            
                    const newUser = {
                        name: newUserName,
                        surname: newUserSurname,
                        email: newUserEmail,
                        password: newUserPassword,
                        admin: newUserAdmin
                    };
            
                    axios.post('/users/admin/create-user', newUser, { headers: { 'user-id': loggedInUserId } })
                        .then(response => {
                            alert(`User ${response.data.name} created successfully.`);
                            clearAdminForm();
                        })
                        .catch(error => {
                            console.error('Error creating user:', error.response?.data || error.message);
                            alert('Error creating user. Please check the console for details.');
                        });
                }
            
                function clearAdminForm() {
                    document.getElementById('newUserName').value = '';
                    document.getElementById('newUserSurname').value = '';
                    document.getElementById('newUserEmail').value = '';
                    document.getElementById('newUserPassword').value = '';
                    document.getElementById('newUserAdmin').value = 'false';
                }
            </script>
    </body>
</html>
