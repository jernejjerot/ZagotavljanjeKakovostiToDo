<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>To-Do App</title>
        <link rel="stylesheet" href="css/styles.css">
    </head>
    <body>
        <div class="container">
            <h1>To-Do List</h1>

            <div class="navigation">
                <a href="register.html">Register</a>
                <a href="editUser.html">Edit Account</a>
            </div>

            <!-- Login Form -->
            <div class="login-container" style="position: absolute; top: 20px; right: 20px;">
                <input type="text" id="username" placeholder="Enter email">
                <input type="password" id="password" placeholder="Enter password">
                <button id="loginBtn">Login</button>
            </div>
            <div class="logout-container" style="position: absolute; top: 60px; right: 20px;">
                <button id="logoutBtn">Logout</button>
            </div>

            <!-- Task Input Form -->
            <div class="input-container">
                <input type="text" id="newTask" placeholder="Enter new task...">
                <input type="text" id="taskDescription" placeholder="Enter task description...">
                <select id="responsibilitySelect">
                    <option value="1">School</option>
                    <option value="2">Work</option>
                    <option value="3">Home</option>
                </select>
                <input type="date" id="dueDate" placeholder="Select due date">
                <button id="addTaskBtn">Add Task</button>
            </div>
            <ul id="taskList"></ul>

            <!-- Admin: Create User Form -->
            <div id="adminContainer" style="display: none; margin-top: 20px;">
                <h2>Create New User</h2>
                <input type="text" id="newUserName" placeholder="First Name">
                <input type="text" id="newUserSurname" placeholder="Last Name">
                <input type="email" id="newUserEmail" placeholder="Email">
                <input type="password" id="newUserPassword" placeholder="Password">
                <button id="createUserBtn">Create User</button>
            </div>
        </div>

        <!-- Axios CDN -->
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

        <script>
            let loggedInUserId = null;
            let isAdmin = false;
            let taskBeingEdited = null;

            document.addEventListener('DOMContentLoaded', () => {
                // Check if user is logged in
                const storedUserId = localStorage.getItem('loggedInUserId');
                const storedIsAdmin = localStorage.getItem('isAdmin');
                if (storedUserId) {
                    loggedInUserId = storedUserId;
                    isAdmin = storedIsAdmin === 'true';
                    document.querySelector('.login-container').innerHTML = `Logged in as User ID: ${storedUserId}`;

                    if (isAdmin) {
                        document.getElementById('adminContainer').style.display = 'block';
                    }
                }

                // Attach event listeners
                const loginBtn = document.getElementById('loginBtn');
                const addTaskBtn = document.getElementById('addTaskBtn');
                const logoutBtn = document.getElementById('logoutBtn');
                const createUserBtn = document.getElementById('createUserBtn');

                if (loginBtn) loginBtn.addEventListener('click', loginUser);
                if (addTaskBtn) addTaskBtn.addEventListener('click', addOrUpdateTask);
                if (logoutBtn) logoutBtn.addEventListener('click', logoutUser);
                if (createUserBtn) createUserBtn.addEventListener('click', createUser);

                // Fetch tasks for the logged-in user
                fetchTasks();
            });

            function loginUser() {
                const email = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                axios.post('/users/login', { email, password })
                    .then(response => {
                        const user = response.data;
                        localStorage.setItem('loggedInUserId', user.userId);
                        localStorage.setItem('isAdmin', user.isAdmin);

                        loggedInUserId = user.userId;
                        isAdmin = user.isAdmin;

                        alert('Login successful');
                        document.querySelector('.login-container').innerHTML = `Logged in as ${user.email}`;

                        if (isAdmin) {
                            document.getElementById('adminContainer').style.display = 'block';
                        }

                        fetchTasks();
                    })
                    .catch(error => {
                        console.error('Error logging in:', error);
                        alert('Login failed');
                    });
            }

            function logoutUser() {
                localStorage.removeItem('loggedInUserId');
                localStorage.removeItem('isAdmin');
                loggedInUserId = null;
                isAdmin = false;

                alert('Logged out successfully.');
                window.location.href = 'index.html';
            }

            function fetchTasks() {
                if (!loggedInUserId) {
                    alert('Please log in to view tasks.');
                    return;
                }

                axios.get('/tasks', { headers: { 'user-id': loggedInUserId } })
                    .then(response => {
                        const taskList = document.getElementById('taskList');
                        taskList.innerHTML = '';

                        response.data.forEach(task => {
                            const li = document.createElement('li');
                            const formattedDate = new Date(task.dueDate).toLocaleDateString();
                            li.textContent = `${task.taskName}: ${task.description} (Due: ${formattedDate})`;
                            createTaskElements(li, task);
                            taskList.appendChild(li);
                        });
                    })
                    .catch(error => console.error('Error fetching tasks:', error));
            }

            function addOrUpdateTask() {
                const taskName = document.getElementById('newTask').value.trim();
                const taskDescription = document.getElementById('taskDescription').value.trim();
                const responsibilityId = document.getElementById('responsibilitySelect').value;
                const dueDate = document.getElementById('dueDate').value;

                if (!taskName || !taskDescription || !dueDate || !loggedInUserId) {
                    alert('Please fill in all fields and log in.');
                    return;
                }

                const taskData = {
                    taskName,
                    description: taskDescription,
                    responsibility: { id: responsibilityId },
                    dueDate,
                    isCompleted: false,
                };

                axios.post('/tasks', taskData, { headers: { 'user-id': loggedInUserId } })
                    .then(() => {
                        alert('Task created successfully');
                        fetchTasks();
                        clearTaskForm();
                    })
                    .catch(error => {
                        console.error('Error creating task:', error);
                        alert('Failed to create task');
                    });
            }

            function createTaskElements(li, task) {
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => editTask(task));
                li.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => {
                    axios.delete(`/tasks/${task.id}`, { headers: { 'user-id': loggedInUserId } })
                        .then(fetchTasks)
                        .catch(error => console.error('Error deleting task:', error));
                });
                li.appendChild(deleteBtn);
            }

            function editTask(task) {
                document.getElementById('newTask').value = task.taskName;
                document.getElementById('taskDescription').value = task.description;
                document.getElementById('responsibilitySelect').value = task.responsibility.id;
                document.getElementById('dueDate').value = new Date(task.dueDate).toISOString().substring(0, 10);

                taskBeingEdited = task;
            }

            function clearTaskForm() {
                document.getElementById('newTask').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('dueDate').value = '';
                taskBeingEdited = null;
            }

            function createUser() {
                const name = document.getElementById('newUserName').value.trim();
                const surname = document.getElementById('newUserSurname').value.trim();
                const email = document.getElementById('newUserEmail').value.trim();
                const password = document.getElementById('newUserPassword').value.trim();

                if (!name || !surname || !email || !password) {
                    alert('All fields are required.');
                    return;
                }

                axios.post('/users/admin/create-user', {
                    name,
                    surname,
                    email,
                    password,
                }, { headers: { 'user-id': loggedInUserId } })
                .then(() => {
                    alert('User created successfully');
                    document.getElementById('newUserName').value = '';
                    document.getElementById('newUserSurname').value = '';
                    document.getElementById('newUserEmail').value = '';
                    document.getElementById('newUserPassword').value = '';
                })
                .catch(error => {
                    console.error('Error creating user:', error.response?.data || error.message);
                    alert('Failed to create user');
                });
            }
        </script>
    </body>
</html>